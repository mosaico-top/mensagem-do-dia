<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sua Mensagem de Incentivo</title>
  <meta property="og:title" content="Sua Mensagem de Incentivo">
  <meta property="og:description" id="og-description" content="Receba uma mensagem inspiradora e especial.">
  <meta property="og:image" content="https://mosaico-top.github.io/mensagem-do-dia/logo.png">
  <meta property="og:url" content="https://mosaico-top.github.io/mensagem-do-dia/">
  <meta property="og:type" content="website">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Layouts base */
    body {
      transition: background 0.6s ease, color 0.6s ease;
    }

    .content-section {
      background: rgba(255, 255, 255, 0.45);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: all 0.6s ease;
    }

    .content-wrapper {
      opacity: 0;
      transform: translateY(15px);
      animation: slideUp 0.6s ease forwards;
    }
    @keyframes slideUp {
      to {opacity: 1; transform: translateY(0);}
    }

    #content-title {
      font-size: 0.9rem;
      font-weight: 400;
      color: #374151;
      transition: color 0.3s ease;
    }
    #content-title:hover {
      color: #2563eb;
    }

    #offer-description {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    .cta-button {
      border-radius: 9999px;
      font-size: 0.8rem;
      padding: 0.55rem 1.4rem;
      font-weight: 500;
      background: linear-gradient(135deg, #60a5fa, #2563eb);
      color: white;
      transition: transform 0.25s ease;
    }
    .cta-button:hover {
      transform: scale(1.05);
    }

    /* Fade para troca de ofertas */
    .fade-out { opacity: 0; transition: opacity 0.4s ease; }
    .fade-in { opacity: 1; transition: opacity 0.4s ease; }

    /* 🌑 Dark Mode */
    body.dark {
      background: linear-gradient(135deg, #0f172a, #1e293b, #111827);
      color: #f3f4f6;
    }

    body.dark .message-app-container {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(18px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    body.dark #lucky-message-text {
      color: #f9fafb;
    }

    body.dark .content-section {
      background: rgba(30, 41, 59, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    }

    body.dark #content-title {
      color: #e5e7eb;
    }

    body.dark #offer-description {
      color: #9ca3af;
    }

    body.dark .cta-button {
      background: linear-gradient(135deg, #818cf8, #4f46e5);
      color: white;
    }

    body.dark .loading-state {
      color: #9ca3af;
    }

    /* Botão Dark Mode */
    #dark-toggle {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(8px);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.3s ease;
    }
    #dark-toggle:hover {
      background: rgba(255,255,255,0.9);
    }
    body.dark #dark-toggle {
      background: rgba(17,24,39,0.7);
      color: #f9fafb;
    }
    body.dark #dark-toggle:hover {
      background: rgba(17,24,39,0.9);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center p-4">

  <!-- Container Principal -->
  <div class="main-container w-full max-w-2xl flex flex-col gap-4">

    <!-- Mensagem Inspiradora -->
    <div class="message-app-container shadow-lg rounded-3xl p-6 text-center flex flex-col items-center justify-center min-h-[150px] transform transition-transform duration-300 hover:scale-[1.01] backdrop-blur-md">
      <p id="lucky-message-text" class="text-xl md:text-2xl text-gray-700 font-semibold italic min-h-[50px] flex items-center justify-center animate-pulse">Buscando inspiração...</p>
      
      <div id="message-buttons" class="mt-6 flex flex-col sm:flex-row gap-4 items-center">
        <button id="get-message-button" class="px-6 py-3 bg-emerald-500 text-white font-bold rounded-full shadow-lg hover:bg-emerald-600 transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
          🔮 Buscar inspiração
        </button>
        <button id="share-button" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 hidden flex items-center gap-2">
          📤 Compartilhar
        </button>
        <button id="copy-button" class="px-6 py-3 bg-slate-500 text-white font-bold rounded-full shadow-lg hover:bg-slate-600 transition-all duration-300 transform hover:scale-105 hidden flex items-center gap-2">
          📋 Copiar
        </button>
      </div>
      
      <div id="copy-confirmation" class="copy-confirmation mt-2 text-sm text-green-600 font-semibold">
        Mensagem copiada!
      </div>
    </div>

    <!-- Carrossel de Ofertas -->
    <div id="content-area" class="content-section bg-slate-100 shadow-lg rounded-3xl p-6 min-h-[120px] flex flex-col justify-center items-center relative mt-4 transform transition-transform duration-300 hover:scale-[1.01]">
      <button class="absolute top-4 right-4 p-2 bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center text-gray-600 hover:bg-gray-400 transition-transform duration-300" id="collapse-button" title="Recolher Carrossel">
        <svg id="collapse-icon-up" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6 fill-current"><path d="M7 10l5 5 5-5z"/></svg>
        <svg id="collapse-icon-down" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6 fill-current"><path d="M7 14l5-5 5 5z"/></svg>
      </button>
      <div class="loading-state flex-grow text-center text-gray-500 font-semibold">
        Carregando ofertas...
      </div>
      <div class="content-wrapper w-full flex flex-col md:flex-row items-center justify-center gap-6">
        <img class="content-image w-36 h-36 md:w-28 md:h-28 object-cover rounded-2xl flex-shrink-0 shadow-lg transform transition-transform duration-300 hover:scale-105" id="content-image" src="" alt="Imagem da Oferta"/>
        <div class="flex-grow text-center md:text-left flex flex-col items-center md:items-start">
          <h3 class="text-lg font-bold text-gray-900" id="content-title"></h3>
          <p id="offer-description" class="offer-description text-gray-600 mt-2 text-sm md:text-base">Confira essa oferta especial!</p>
          <a class="cta-button mt-4 px-8 py-3 text-sm md:text-base" id="cta-button" href="" target="_blank" rel="noopener noreferrer">Veja Mais...</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Botão Dark Mode -->
  <div id="dark-toggle">🌙</div>

  <script>
    // API Mensagens
    const MESSAGE_API_URL = "https://script.google.com/macros/s/AKfycbxCvoSUZh1JjsnhBdgtUTi46Q9WPTEMyOhKa9TyM3ziPH29Y6g_5KPkEqOJ0ZO6dJJf/exec";
    const luckyMessageText = document.getElementById('lucky-message-text');
    const getMessageButton = document.getElementById('get-message-button');
    const shareButton = document.getElementById('share-button');
    const copyButton = document.getElementById('copy-button');
    const copyConfirmation = document.getElementById('copy-confirmation');
    const ogDescriptionMeta = document.getElementById('og-description');
    const MAX_RETRIES = 3;

    async function fetchLuckyMessage(retries = MAX_RETRIES) {
      getMessageButton.disabled = true;
      shareButton.classList.add('hidden');
      copyButton.classList.add('hidden');
      luckyMessageText.textContent = "Buscando inspiração...";
      luckyMessageText.classList.add('animate-pulse');
      
      try {
        const response = await fetch(MESSAGE_API_URL);
        if (!response.ok) throw new Error(`Erro HTTP! Status: ${response.status}`);
        const data = await response.json();
        if (data && data.message) {
          luckyMessageText.textContent = data.message;
          updateMetaTags(data.message);
          if (navigator.share) shareButton.classList.remove('hidden'); 
          else copyButton.classList.remove('hidden');
        } else {
          luckyMessageText.textContent = "Não foi possível carregar as mensagens.";
        }
      } catch (error) {
        luckyMessageText.textContent = "Erro de rede. Tente novamente.";
      } finally {
        getMessageButton.disabled = false;
        luckyMessageText.classList.remove('animate-pulse');
      }
    }
    
    function updateMetaTags(message) {
      ogDescriptionMeta.setAttribute('content', message);
    }

    function shareMessage() {
      const messageToShare = luckyMessageText.textContent;
      const appUrl = window.location.href;
      const fullMessage = `✨ Mensagem do Dia ✨\n\n"${messageToShare}"\n\nConfira mais no app: ${appUrl}`;
      if (navigator.share) {
        navigator.share({ title: 'Mensagem de Incentivo', text: fullMessage, url: appUrl });
      } else copyMessage();
    }

    function copyMessage() {
      const messageToCopy = luckyMessageText.textContent;
      const appUrl = window.location.href;
      const fullMessage = `✨ Mensagem do Dia ✨\n\n"${messageToCopy}"\n\nConfira mais no app: ${appUrl}`;
      const tempTextarea = document.createElement('textarea');
      tempTextarea.value = fullMessage;
      document.body.appendChild(tempTextarea);
      tempTextarea.select();
      try {
        document.execCommand('copy');
        copyConfirmation.classList.add('visible');
        setTimeout(() => copyConfirmation.classList.remove('visible'), 2000);
      } catch {}
      document.body.removeChild(tempTextarea);
    }

    getMessageButton.addEventListener('click', fetchLuckyMessage);
    shareButton.addEventListener('click', shareMessage);
    copyButton.addEventListener('click', copyMessage);

    // Carrossel Ofertas
    const OFFERS_CSV_URL = "https://docs.google.com/spreadsheets/d/1S_BVbwRlP4Vpin5clCRC_2ILZTBzuhvqLQrSgUcfPxM/export?format=csv&gid=1150732258";
    const OFFERS_CACHE_KEY = 'mosaico_offers_data';
    const OFFERS_CACHE_EXPIRY = 3600000;

    const contentSection = document.getElementById('content-area');
    const contentWrapper = contentSection.querySelector('.content-wrapper');
    const contentTitleElement = document.getElementById('content-title');
    const offerDescription = document.getElementById('offer-description');
    const ctaButton = document.getElementById('cta-button');
    const contentImage = document.getElementById('content-image');
    const collapseButton = document.getElementById('collapse-button');
    const collapseIconUp = document.getElementById('collapse-icon-up');
    const collapseIconDown = document.getElementById('collapse-icon-down');
    const loadingOffers = contentSection.querySelector('.loading-state');

    let offersData = [];
    let offerIntervalId = null;
    let isCollapsed = false;

    function parseCsvLine(line) {
      const result = []; let inQuote = false; let currentField = '';
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuote = !inQuote;
          if (!inQuote && line[i + 1] === '"') { currentField += '"'; i++; }
        } else if (char === ',' && !inQuote) {
          result.push(currentField.trim()); currentField = '';
        } else { currentField += char; }
      }
      result.push(currentField.trim());
      return result;
    }

    async function fetchAndParseCsv(url, retries = MAX_RETRIES) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erro HTTP! Status: ${response.status}`);
        let csvText = await response.text();
        if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.substring(1);
        const lines = csvText.split('\n').filter(l => l.trim() !== '');
        if (lines.length <= 1) return [];
        const headers = parseCsvLine(lines[0]).map(h => h.trim());
        return lines.slice(1).map(line => {
          const values = parseCsvLine(line);
          const row = {}; headers.forEach((h,i) => row[h] = (values[i] || '').replace(/\r$/, ''));
          return row;
        });
      } catch (e) {
        if (retries > 0) return fetchAndParseCsv(url, retries-1);
        return [];
      }
    }

    function updateOffer() {
      if (offersData.length === 0) { contentSection.classList.add('hidden'); return; }
      contentWrapper.classList.add('fade-out');
      setTimeout(() => {
        const randomIndex = Math.floor(Math.random() * offersData.length);
        const randomOffer = offersData[randomIndex];
        if (randomOffer) {
          contentTitleElement.textContent = randomOffer['Item_Name'] || "Oferta Especial";
          offerDescription.textContent = randomOffer['Description'] || "";
          contentImage.src = randomOffer['img'] || "https://placehold.co/120x120/E0E0E0/808080?text=Sem+Imagem";
          if (randomOffer['Offer_Link']) { ctaButton.href = randomOffer['Offer_Link']; ctaButton.style.display = 'inline-block'; }
          else ctaButton.style.display = 'none';
        }
        contentWrapper.classList.remove('fade-out'); contentWrapper.classList.add('fade-in');
        if (loadingOffers) loadingOffers.style.display = "none";
      }, 400);
    }

    async function fetchOffersAndStartRotation() {
      let cachedData = sessionStorage.getItem(OFFERS_CACHE_KEY);
      let cachedTime = sessionStorage.getItem(`${OFFERS_CACHE_KEY}_time`);
      if (cachedData && cachedTime && (Date.now() - cachedTime < OFFERS_CACHE_EXPIRY)) {
        offersData = JSON.parse(cachedData);
      } else {
        const raw = await fetchAndParseCsv(OFFERS_CSV_URL);
        offersData = raw.filter(o => o.img && o.img.trim() !== '');
        if (offersData.length > 0) {
          sessionStorage.setItem(OFFERS_CACHE_KEY, JSON.stringify(offersData));
          sessionStorage.setItem(`${OFFERS_CACHE_KEY}_time`, Date.now());
        }
      }
      if (offersData.length > 0) {
        updateOffer();
        if (offerIntervalId) clearInterval(offerIntervalId);
        offerIntervalId = setInterval(updateOffer, 10000);
      } else { contentSection.classList.add('hidden'); }
    }

    function toggleCollapse() {
      isCollapsed = !isCollapsed;
      if (isCollapsed) {
        collapseIconDown.style.display = 'block'; collapseIconUp.style.display = 'none';
      } else {
        collapseIconDown.style.display = 'none'; collapseIconUp.style.display = 'block';
      }
    }

    // Dark Mode
    const darkToggle = document.getElementById("dark-toggle");
    darkToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      darkToggle.textContent = document.body.classList.contains("dark") ? "☀️" : "🌙";
    });

    window.onload = function() {
      fetchLuckyMessage();
      fetchOffersAndStartRotation();
      collapseButton.addEventListener('click', toggleCollapse);
    };
  </script>
</body>
</html>
